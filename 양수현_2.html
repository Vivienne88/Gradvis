<html>
    <head>
        <meta charset="utf-8">
        <script src="https://d3js.org/d3.v6.min.js"></script>
    </head>
    <style>
        .line {
          fill: none;
          stroke: steelblue;
          stroke-width: 2px;
        }    
    </style>
    <body>
        <h2>2019-25475 양수현</h2>
        <h2>KBO Rankings</h2>
        <div>
            <select id="year_sel"></select>
            <select id="choice_sel">
                <option value="rank">Rank</option>
                <option value="win_rate">WR</option>
                <option value="diff_game">DG</option>
            </select>
        </div>
        <div>
            <div>
                <svg id="table" width="420px" height="500px">
                    <text x="420" y="20">
                        <tspan></tspan>
                        <tspan x="10">rank</tspan>
                        <tspan x="60">team</tspan>
                        <tspan x="145">W</tspan>
                        <tspan x="185">D</tspan>
                        <tspan x="225">L</tspan>
                        <tspan x="265">win_rate</tspan>
                        <tspan x="340">diff_game</tspan>
                        <tspan x="410"></tspan>
                    </text>    
                </svg>    
                <svg id="line_chart" width="600px" height="500px"></svg>
                <svg id="stack_chart" width="480px" height="500px"></svg>
            </div>           
        </div>
        <script>            
            d3.json("data.json").then(function(data){
                console.log(data);
                
                let teams = []
                data.map(d => d["rankings"].map(d => teams.push(d["team"])));
                teams_unique = [...new Set(teams)]; 
                
                let dic = {}
                teams_unique.map((d, i) => dic[d] = i + 1);

                let color = d3.interpolateRainbow;
                let color_unit = (1/teams_unique.length);
                
                let keys = ["W","D","L"];
                
                function group_z(team_index, x, y, games){
                    team_color = color(color_unit * team_index);

                    new_color = d3.rgb(team_color).darker(2);
                    scale = d3.scaleOrdinal()
                    .range([team_color, "rgb(128,128,128)", `rgb(${new_color.r},${new_color.g},${new_color.b})`])
                    .domain(keys) 

                    if(x == 0){
                        return scale(keys[0]);
                    } else if(y == games){
                        return scale(keys[2]);
                    } else {
                        return scale(keys[1]);
                    }
                }

                let team_dic = {}
                teams_unique.map((d, i) => team_dic[d] = i);

                let lines = [];
                teams_unique.map(d => lines.push([]));

                row_data = data[0];
                let teams_by_year = row_data.rankings.map(d => d.team);

                function init(){
                    data.forEach(function(d) {
                        d.year = +d.year
                        d.rankings.map(function(v){ 
                            v.rank = +v.rank
                            v.games = +v.games
                            v.W = +v.W
                            v.L = +v.L
                            v.D = +v.D
                            v.win_rate = +v.win_rate
                            v.diff_rate = +v.diff_rate
                            v.diff_game = +v.diff_game
                        });
                    });

                    let year_data = data.map(d => +d['year']).sort(d3.ascending);
                    let year_html = d3.select('#year_sel')
                    .selectAll("option")
                    .data(year_data)
                    .enter()
                    .append("option")
                    .text(function(d){
                        return d;
                    })
                    .attr("value", function(d){
                        return d;
                    });

                    let choice_selected = d3.select("#choice_sel").property("value")    
                    let row_data = data[0]['rankings'].sort(function(a, b){
                        if(choice_selected == "rank" || choice_selected == "diff_game"){
                            return a[choice_selected] - b[choice_selected];
                        } else {
                            return b[choice_selected] - a[choice_selected];
                        }                                
                    });

                    console.log(row_data);

                    let table_svg = d3.select('#table')
                    .selectAll("text")
                    .data(row_data, function(d){
                        try{
                            return d["team"];
                        } catch {
                            console.log("promise error")
                        }
                    })
                    .enter()
                    .append("text")
                    .attr("x", 420)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("class", "table_context")
                    .on('mouseenter', (event, d) => {
                        console.log("enter")
                        d3.select(event.currentTarget)
                        .attr("font-weight", 900)
                    })
                    .on('mouseleave', (event, d) => {
                        console.log("leave")
                        d3.select(event.currentTarget)
                        .attr("font-weight", 100)
                    })
                    .append("tspan")
                    .attr("x", 10)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "rank")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["rank"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 60)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "team")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["team"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 145)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "W")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["W"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 185)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "D")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["D"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 225)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "L")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["L"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 265)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "win_rate")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["win_rate"])
                    .select(function(){
                        return this.parentNode
                    })
                    .append("tspan")
                    .attr("x", 340)
                    .attr("y", (d, i) => 20 * (i + 2))
                    .attr("id", d => d["team"] + "diff_game")
                    .attr("class", d => d["team"])
                    .style("fill", d => color(color_unit * dic[d["team"]]))
                    .text(d => d["diff_game"])

                    let line_margin = {top: 20, right: 20, bottom: 30, left: 50},
                    line_width = 600 - line_margin.left - line_margin.right,
                    line_height = 500 - line_margin.top - line_margin.bottom;

                    let x = d3.scaleLinear().range([0, line_width]);
                    let y = d3.scaleLinear().range([line_height, 0]);

                    let valueline = d3.line()
                        .x(function(d) { return x(d[0]); })
                        .y(function(d) { return y(d[1]); });

                    let line_svg = d3.select("#line_chart")
                        .attr("width", line_width + line_margin.left + line_margin.right)
                        .attr("height", line_height + line_margin.top + line_margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + line_margin.left + "," + line_margin.top + ")")

                    let line_path = line_svg.selectAll('path');

                    x.domain([
                        d3.min(data, function(d){ return d.year; })
                        , d3.max(data, function(d) { return d.year; })
                    ]);

                    y.domain([
                        d3.max(data, function(d){ return d3.max(d.rankings, f => f.rank) })
                        , d3.min(data, function(d){ return d3.min(d.rankings, f => f.rank) }) 
                    ]);

                    data.forEach(function(d) {
                        year = d.year;
                        row = d.rankings;

                        row.forEach(function(e){
                        D = e.D;
                        L = e.L;
                        W = e.W;
                        diff_game = e.diff_game;
                        diff_rate = e.diff_rate;
                        games = e.games;
                        rank = e.rank;
                        team = e.team;
                        win_rate = e.win_rate;
                        index = team_dic[team];
                        lines[index].push([year, rank]);
                        });
                    });

                    lines.forEach(function(team_line, i){
                        team_name = teams_unique[i];
                        let k = 0;

                        if(teams_by_year.includes(team_name)){
                            line_path.
                            data([team_line])
                            .enter()
                            .append("path")
                            .on('mouseenter', (event, d) => {
                                d3.select(event.currentTarget)
                                .style("stroke-width", 5)
                            })
                            .on('mouseleave', (event, d) => {
                                d3.select(event.currentTarget)
                                .style("stroke-width", 2)
                            })
                            .attr("class", "line")
                            .style("stroke", color(color_unit * dic[team_name]))
                            .attr("d", valueline)
                        }
                    });

                    line_svg.append("g")
                        .attr("class", "line_axis")
                        .attr("transform", "translate(0," + line_height + ")")
                        .call(d3.axisBottom(x));

                    line_svg.append("g")
                        .attr("class", "line_axis")
                        .call(d3.axisLeft(y));

                    let svg = d3.select("#stack_chart"),
                        margin = {top: 35, left: 35, bottom: 0, right: 0},
                        width = 480 - margin.left - margin.right,
                        height = 500 - margin.top - margin.bottom;

                    let stack_x = d3.scaleBand()
                        .range([margin.left, width - margin.right])
                        .padding(0.1)

                    let stack_y = d3.scaleLinear()
                        .rangeRound([height - margin.bottom, margin.top])

                    let stack_y2 = d3.scaleLinear()
                        .rangeRound([margin.top, height - margin.bottom])

                    let stack_xAxis = svg.append("g")
                        .attr("transform", `translate(0,${height - margin.bottom})`)
                        .attr("class", "x-axis")

                    let stack_yAxis = svg.append("g")
                        .attr("transform", `translate(${margin.left},0)`)
                        .attr("class", "y-axis")

                    let stack_yAxis2 = svg.append("g")
                        .attr("transform", `translate(${width - margin.right},0)`)
                        .attr("class", "y-axis2")

                    row_data.forEach(function(d) {
                        d.total = d3.sum(keys, k => +d[k])
                        return d
                    })

                    stack_y.domain([0, d3.max(row_data, d => d.games)])

                    stack_y2.domain([0, d3.max(row_data, d => d.games)])

                    svg.selectAll(".y-axis").transition().duration(0)
                        .call(d3.axisLeft(stack_y).ticks(null, "s"))

                    svg.selectAll(".y-axis2").transition().duration(0)
                        .call(d3.axisRight(stack_y2).ticks(null, "s"))

                    let selected_teams = []
                    row_data.map(d => selected_teams.push(d["team"]));
                    selected_teams = [...new Set(selected_teams)];

                    stack_x.domain(selected_teams);

                    svg.selectAll(".x-axis").transition().duration(0)
                        .call(d3.axisBottom(stack_x).tickSizeOuter(0))

                    let group = svg.selectAll("g.layer")
                        .data(d3.stack().keys(keys)(row_data), d => d.key)

                    group.exit().remove()

                    group.enter().append("g")
                        .classed("layer", true)

                    let bars = svg.selectAll("g.layer").selectAll("rect")
                        .data(d => d, e => e.data.team)

                    bars.exit().remove()

                    bars.enter().append("rect")
                        .on('mouseenter', (event, d) => {
                            console.log("enter");
                            d3.select(event.currentTarget)
                            .attr('stroke', 'black')
                            .style("stroke-width", 3)
                        })
                        .on('mouseleave', (event, d) => {
                            console.log("leave");
                            d3.select(event.currentTarget)
                            .style("stroke-width", 0)
                        })
                        .merge(bars)
                    .transition().duration(0)
                        .attr("width", stack_x.bandwidth())
                        .attr("x", d => stack_x(d.data.team))
                        .attr("y", d => stack_y(d[1]))
                        .attr("class", (d, i) => "xax" + i)
                        .attr("height", d => stack_y(d[0]) - stack_y(d[1]))
                        .attr("fill", d => group_z(team_dic[d.data.team], d[0], d[1], d.data.games))
                }

                function update(){
                    let l = 0;
                    let year_selected = d3.select("#year_sel").property("value")

                    for(l=0;l<data.length;l++){                    
                        if(data[l]['year'] == year_selected){
                            let choice_selected = d3.select("#choice_sel").property("value")    
                            let row_data = data[l]['rankings'].sort(function(a, b){
                                if(choice_selected == "rank" || choice_selected == "diff_game"){
                                    return a[choice_selected] - b[choice_selected];
                                } else {
                                    return b[choice_selected] - a[choice_selected];
                                }                                
                            });
                            
                            d3.selectAll(".table_context").remove();

                            console.log(row_data);
                            let table_svg = d3.select('#table')
                            .selectAll(".table_context")
                            .data(row_data, function(d){
                                try{
                                    return d["team"];
                                } catch {
                                    console.log("promise error")
                                }
                            })
                            .join(
                                enter => enter                            
                                .append("text")
                                .attr("x", 420)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("class", "table_context")
                                .attr("id", d => d["team"] + "table_context")
                                .on('mouseenter', (event, d) => {
                                    d3.select(event.currentTarget)
                                    .attr("font-weight", 900)
                                })
                                .on('mouseleave', (event, d) => {
                                    d3.select(event.currentTarget)
                                    .attr("font-weight", 100)
                                })
                                .append("tspan")
                                .attr("x", 10)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "rank")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["rank"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 60)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "team")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["team"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 145)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "W")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["W"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 185)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "D")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["D"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 225)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "L")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["L"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 265)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "win_rate")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["win_rate"])
                                .select(function(){
                                    return this.parentNode
                                })
                                .append("tspan")
                                .attr("x", 340)
                                .attr("y", (d, i) => 20 * (i + 2))
                                .attr("id", d => d["team"] + "diff_game")
                                .attr("class", d => d["team"])
                                .style("fill", d => color(color_unit * dic[d["team"]]))
                                .text(d => d["diff_game"])
                                .call(enter => enter.
                                selectAll('.table_content')
                                .transition(1200)
                                .style('opacity', 0))
                                ,
                                update => update
                                .call(update => update
                                    .transition()
                                    .duration(1200)
                                    .each(function(d, i){
                                        team = d["team"]

                                        console.log(d["rank"]);
                                        console.log(d["team"]);
                                        console.log(d["W"]);
                                        console.log(d["D"]);
                                        console.log(d["L"]);
                                        console.log(d["win_rate"]);
                                        console.log(d["diff_game"]);
                                        console.log(d["game"]);

                                        d3.select('#' + team + "rank")
                                        .text(d["rank"])   

                                        d3.select('#' + team + "team")
                                        .text(d["team"])   

                                        d3.select('#' + team + "W")
                                        .text(d["W"])   

                                        d3.select('#' + team + "D")
                                        .text(d["D"])   

                                        d3.select('#' + team + "L")
                                        .text(d["L"])   

                                        d3.select('#' + team + "win_rate")
                                        .text(d["win_rate"])   

                                        d3.select('#' + team + "diff_game")
                                        .text(d["diff_game"])
                                    })
                                    .style('opacity', 1)
                                )
                                ,
                                exit => exit
                                .exit()
                                .remove()
                            )

                            
                            let svg = d3.select("#stack_chart"),
                                margin = {top: 35, left: 35, bottom: 0, right: 0},
                                width = 480 - margin.left - margin.right,
                                height = 500 - margin.top - margin.bottom;

                            let selected_teams = []
                            row_data.map(d => selected_teams.push(d["team"]));
                            selected_teams = [...new Set(selected_teams)];
                            console.log(selected_teams);

                            let stack_x = d3.scaleBand()
                                .domain(selected_teams)
                                .range([margin.left, width - margin.right])
                                .padding(0.1)

                            let stack_y = d3.scaleLinear()
                                .rangeRound([height - margin.bottom, margin.top])

                            let stack_y2 = d3.scaleLinear()
                                .rangeRound([margin.top, height - margin.bottom])

                            let stack_xAxis = svg.append("g")
                                .attr("transform", `translate(0,${height - margin.bottom})`)
                                .attr("class", "x-axis")

                            let stack_yAxis = svg.append("g")
                                .attr("transform", `translate(${margin.left},0)`)
                                .attr("class", "y-axis")

                            let stack_yAxis2 = svg.append("g")
                                .attr("transform", `translate(${width - margin.right},0)`)
                                .attr("class", "y-axis2")

                            let stack_z = d3.scaleOrdinal()
                                .range(["steelblue", "darkorange", "lightblue"])
                                .domain(keys);

                            row_data.forEach(function(d) {
                                d.total = d3.sum(keys, k => +d[k])
                                return d
                            })

                            stack_y.domain([0, d3.max(row_data, d => d.games)]);

                            stack_y2.domain([0, d3.max(row_data, d => d.games)]);

                            svg.selectAll(".y-axis").transition().duration(1200)
                                .call(d3.axisLeft(stack_y).ticks(null, "s"))

                            svg.selectAll(".y-axis2").transition().duration(1200)
                                .call(d3.axisRight(stack_y2).ticks(null, "s"))

                            svg.selectAll(".x-axis").transition().duration(1200)
                                .call(d3.axisBottom(stack_x).tickSizeOuter(0))

                            let group = svg.selectAll("g.layer")
                                .data(d3.stack().keys(keys)(row_data), d => d.key)

                            group.exit().remove()

                            group.enter().append("g")
                                .classed("layer", true)

                            let bars = svg.selectAll("g.layer").selectAll("rect")
                                .data(d => d, e => e.data.team);

                            bars.exit().remove()

                            bars.enter().append("rect")
                                .on('mouseenter', (event, d) => {
                                    console.log("enter");
                                    d3.select(event.currentTarget)
                                    .attr('stroke', 'black')
                                    .style("stroke-width", 3)
                                })
                                .on('mouseleave', (event, d) => {
                                    console.log("leave");
                                    d3.select(event.currentTarget)
                                    .style("stroke-width", 0)
                                })
                                .merge(bars)
                            .transition().duration(1200)
                                .attr("width", stack_x.bandwidth())
                                .attr("x", d => stack_x(d.data.team))
                                .attr("y", d => stack_y(d[1]))
                                .attr("height", d => stack_y(d[0]) - stack_y(d[1]))
                                .attr("fill", d => group_z(team_dic[d.data.team], d[0], d[1], d.data.games))
                        }
                    }
                }

                function update_line(){
                    let l = 0;
                    let year_selected = d3.select("#year_sel").property("value")
                    let choice_selected = d3.select("#choice_sel").property("value")    

                    for(l=0;l<data.length;l++){                    
                        if(data[l]['year'] == year_selected){
                            let choice_selected = d3.select("#choice_sel").property("value")    
                            //lines에 대해서 정렬일듯

                            // let row_data = data[l]['rankings'].sort(function(a, b){
                            //     if(choice_selected == "rank" || choice_selected == "diff_game"){
                            //         return a[choice_selected] - b[choice_selected];
                            //     } else {
                            //         return b[choice_selected] - a[choice_selected];
                            //     }                                
                            // });

                            let teams_by_year = data[l].rankings.map(d => d.team);

                            let line_margin = {top: 20, right: 20, bottom: 30, left: 50},
                            line_width = 600 - line_margin.left - line_margin.right,
                            line_height = 500 - line_margin.top - line_margin.bottom;

                            let x = d3.scaleLinear().range([0, line_width]);
                            let y = d3.scaleLinear().range([line_height, 0]);

                            let valueline = d3.line()
                                .x(function(d) { return x(d[0]); })
                                .y(function(d) { return y(d[1]); });

                            let line_svg = d3.select("#line_chart")
                                .attr("width", line_width + line_margin.left + line_margin.right)
                                .attr("height", line_height + line_margin.top + line_margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + line_margin.left + "," + line_margin.top + ")");
                            
                            let line_path = line_svg
                            .selectAll("path");

                            x.domain([
                                d3.min(data, function(d){ return d.year; })
                                , d3.max(data, function(d) { return d.year; })
                            ]);

                            if(choice_selected == "rank"){
                                y.domain([
                                    d3.max(data, function(d){ return d3.max(d.rankings, f => f.rank) })
                                    , d3.min(data, function(d){ return d3.min(d.rankings, f => f.rank) }) 
                                ]);
                            } else if(choice_selected == "diff_game") {
                                y.domain([
                                    d3.max(data, function(d){ return d3.max(d.rankings, f => f.diff_game) })
                                    , d3.min(data, function(d){ return d3.min(d.rankings, f => f.diff_game) }) 
                                ]);
                            } else if(choice_selected == "win_rate") {
                                y.domain([
                                    d3.min(data, function(d){ return d3.min(d.rankings, f => f.win_rate) })
                                    , d3.max(data, function(d){ return d3.max(d.rankings, f => f.win_rate) }) 
                                ]);
                            }

                            lines = [];
                            teams_unique.map(d => lines.push([]));

                            data.forEach(function(d) {
                                year = d.year;
                                row = d.rankings;

                                row.forEach(function(e){
                                    D = e.D;
                                    L = e.L;
                                    W = e.W;
                                    diff_game = e.diff_game;
                                    diff_rate = e.diff_rate;
                                    games = e.games;
                                    rank = e.rank;
                                    team = e.team;
                                    win_rate = e.win_rate;
                                    index = team_dic[team];

                                    if(choice_selected == "rank") {
                                        lines[index].push([year, rank]);
                                    } else if(choice_selected == "diff_game") {
                                        lines[index].push([year, diff_game]);
                                    } else if(choice_selected == "win_rate") {
                                        lines[index].push([year, win_rate]);
                                    }
                                });
                            });

                            d3.selectAll("path.line").remove();
                            d3.selectAll(".line_axis").remove();

                            lines.forEach(function(team_line, i){
                                team_name = teams_unique[i];
                                let k = 0;

                                if(teams_by_year.includes(team_name)){
                                    // line_path
                                    //     .data([team_line])
                                    //     .exit()
                                    //     .remove();
                                    
                                    line_path
                                        .data([team_line])
                                        .enter()
                                        .append("path")
                                        .attr("class", "line")
                                        .style("stroke", color(color_unit * dic[team_name]))
                                        .attr("d", valueline)
                                        .on('mouseenter', (event, d) => {
                                            d3.select(event.currentTarget)
                                            .style("stroke-width", 5)
                                        })
                                        .on('mouseleave', (event, d) => {
                                            d3.select(event.currentTarget)
                                            .style("stroke-width", 2)
                                        })

                                    // line_path
                                    //     .data([team_line])
                                    //     .attr("class", "line")
                                    //     .style("stroke", color(color_unit * dic[team_name]))
                                    //     .attr("d", valueline);
                                }
                            });

                            line_svg.append("g")
                                .attr("class", "line_axis")
                                .attr("transform", "translate(0," + line_height + ")")
                                .call(d3.axisBottom(x));

                            line_svg.append("g")
                                .attr("class", "line_axis")
                                .call(d3.axisLeft(y));
                        }
                    }    
                }

                init();

                d3.select("#year_sel").on("change", function(event, k){
                    console.log("update");
                    update();
                    update_line();
                });

                d3.select("#choice_sel").on("change", function(event, k){
                    update_line();
                });
            });
        </script>
    </body>
</html>